---

title: Vertex Dynamics Simulation of Cell Monolayers

keywords: fastai
sidebar: home_sidebar

summary: "Vertex dynamics simulation for modelling epithelial tissue dynamics (package description)"
description: "Vertex dynamics simulation for modelling epithelial tissue dynamics (package description)"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Modules:</p>
<ul>
<li><code>primitives</code>: implements vertices (w/ distance), edges, cells (w/ perimeter and area), and monolayer (with energy, boundary constraints, and other parameters)</li>
<li><code>simulation</code>: tools for  simulating cellular vertex dynamics. Iterative algorithm implementations, cell monolayer generators (vertices). (anything else to add?!)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Install">Install<a class="anchor-link" href="#Install"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install vertex_simulation</code> (not yet implemented)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Using-autograd-with-Vertex,-Graph-and-Monolayer">Using autograd with Vertex, Graph and Monolayer<a class="anchor-link" href="#Using-autograd-with-Vertex,-Graph-and-Monolayer"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In examples below, it is assumed that you've imported <code>primitives</code> module. You can do so with</p>

<pre><code>from vertex_simulation.primitives import *</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Initializing-and-working-with-Vertex-and-Graph-objects">Initializing and working with <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a> and <a href="/vertex_simulation/primitives#Graph"><code>Graph</code></a> objects<a class="anchor-link" href="#Initializing-and-working-with-Vertex-and-Graph-objects"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/vertex_simulation/primitives#Graph"><code>Graph</code></a> objects implement graphs and stores its vertices as a <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a> object, and its edges as a <code>torch.tensor</code>. Both <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a> and <a href="/vertex_simulation/primitives#Graph"><code>Graph</code></a> provide interface methods for working with torch's autograd, and methods for calculating edge lengths (or vertex to vertex distance in the case <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To illustrate how to use autograd, let's use <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a> object. We can define <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a> object with its location, or set and modify it later. Location is stored as <a href="/vertex_simulation/primitives#Vertex.x"><code>Vertex.x</code></a> property, a <code>torch.tensor</code>. <code>Vertex(location)</code> accepts <code>torch.tensors</code>, list of lists that are convertible to tensors (with optional keyword arg-s for <code>torch.tensor()</code>), and numpy.ndarrays (uses <code>torch.from_numpy()</code>)</p>
<ul>
<li><code>v.x</code> (i.e. location for <code>v=Vertex(location)</code>) is assumed to be Nx2 array with float dtype (or any 2D array), and sizes are <strong>not</strong> checked when set using <code>self.x</code>.</li>
<li>Computing gradients, and resetting them to zeros. Example below demonstrates computing $\partial y/\partial v_{i,j}$ for $y = \sum_i\sum_j v_{i,j}^2$ using <code>torch.autograd</code>.</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">v</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">([[</span><span class="mf">3.</span><span class="p">,</span><span class="o">-</span><span class="mf">1.</span><span class="p">],[</span><span class="mf">0.1</span><span class="p">,</span><span class="mf">0.</span><span class="p">]],</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="c1"># do some calculation with v.x</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="c1"># calculate grad-s</span>
<span class="n">y</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dy/dx_i after y.backward():</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">grad</span><span class="p">())</span>
<span class="c1"># set grad-s to zeros (useful when you don&#39;t want to accumulate grad-s)</span>
<span class="n">v</span><span class="o">.</span><span class="n">zero_grad_</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;dy/dx_i after zeroing grad-s:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">grad</span><span class="p">())</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Vertex-usage-example">Vertex usage example<a class="anchor-link" href="#Vertex-usage-example"> </a></h4><p><a name="ex1">Trapped particle in a 2D fluid</a></p>
<p>Let's assume linear drag, where force exerted by a spring is proportional to the velocity of the particle (drag force is $F_d=-b\frac{dx(t')}{dt'}$)
{% raw %}
$$F_s(t') = -\nabla U = b\frac{dx(t')}{dt'}$$
{% endraw %}
where $U$ is the potential energy of the spring (e.g. optical trap) $U=k\cdot |r|^2$, where $r$ is the vector from equilibrium point, $o$, pointing to the current location of the particle, $x$. After re-defining time ($t'$) as a relative "scaled" time $t=\frac{t'}{b}$ and taking gradient of potential energy w.r.t. $x$, we can re-write the equation of motion (also let's set $o$ as origin $[0,0]$, then $r=x$)
{% raw %}
$$\frac{dx(t)}{dt}=-2k(x-o)= -2kx$$
{% endraw %}
Let's numerically solve this equation ( <em>refer to the code cell below</em> ). If the scale of the step size is chosen well (e.g. in the code below for large <code>k</code> use smaller <code>Dt</code>), solution $x(t)$ should converge to the equilibrium point $o$.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>One way to model this system is to use two vertices, one for constant equilibrium point $o$, and a second vertex for particle position $x(t)$. To track potential energy gradient w.r.t. $x(t)$ we'll set <code>requires_grad=True</code> for the moving vertex, <code>v1</code> in the code below (this flag enables <code>torch</code>'s autograd to backpropagate the gradients).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">o</span>  <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="c1"># equilibrium point (where U(x) is minimum)</span>
<span class="n">v1</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([[</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">]],</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span> <span class="c1"># particles location</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;distance from equilibrium (r):{r.item():.4f}&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;o requires_grad? :{o.requires_grad()}&#39;</span><span class="p">,</span>
      <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">v1 requires_grad?:{v1.requires_grad()}&#39;</span><span class="p">,</span>
      <span class="n">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">r requires_grad? :</span><span class="si">{r.requires_grad}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="c1"># note that for Vertex self.requires_grad() is a function</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to calculate gradients w.r.t. $x$, we need to set up a function that maps $x$ to some scalar value. In our example, this function is the potential energy function $U(x)$ (<code>energy(r)</code> below). Once <code>energy</code> function is evalutated, we need to call <code>backward()</code> on the returned <code>torch.tensor</code> to calculate (analytic) gradient of potential energy function at $x=v1$ (i.e. $\nabla_x U|_{x=v1}$; <code>dEdx</code> in code below)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Define energy</span>
<span class="n">k</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">energy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">k</span><span class="o">*</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span>
<span class="n">E</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Energy=kr^2 :{E.item():.4f}&#39;</span><span class="p">)</span>
<span class="c1"># compute gradients</span>
<span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
<span class="n">dEdx</span> <span class="o">=</span> <span class="n">v1</span><span class="o">.</span><span class="n">grad</span><span class="p">()</span><span class="o">.</span><span class="n">data</span>
<span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">dEdx</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=0: dE/dx={dEdx.tolist()} --&gt; dx/dt=-dE/dx={dxdt.tolist()}&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>An important point to keep in mind when using iterative methods (e.g. gradient descent) shown in the code below, is to remember to reset gradients accumulator to zeros. For <a href="/vertex_simulation/primitives#Vertex"><code>Vertex</code></a> objects its done with <a href="/vertex_simulation/primitives#Vertex.zero_grad_("><code>Vertex.zero_grad_()</code></a>), if the vertex has <code>requires_grad=True</code> flag, calling this method sets all gradients of a given vertex to zeros. Otherwise it does nothing, e.g. gradients w.r.t. $o$ are kept as <code>None</code>, and they are not calculated.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="o">.</span><span class="mi">16</span> <span class="c1"># time step size</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">v1</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">v1</span><span class="o">.</span><span class="n">zero_grad_</span><span class="p">()</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span>  <span class="c1"># elastic energy, o.dist(v1) is distance from vertex &quot;o&quot;</span>
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>   <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">v1</span><span class="o">.</span><span class="n">grad</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="c1"># dx/dt=-dE/dx</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">%</span><span class="k">5</span>==0:
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t={Dt*n:.2f}:r={o.dist(v1).item():4.3f}; E={E.item():.2g}; dx/dt=</span><span class="si">{dxdt}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">v1</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
    <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v1</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">tolist</span><span class="p">());</span> <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span>
<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energy</span><span class="p">(</span><span class="n">o</span><span class="o">.</span><span class="n">dist</span><span class="p">(</span><span class="n">v1</span><span class="p">))</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Results of the numerical integration above-- the evolution of the system in relative time, are shown below. Keep in mind that, in this simulation time is scaled by drag coefficient $b$, and for more accurate dynamics we need to use smaller <code>Dt</code> (or more accurate method for numerical integration).</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># Display the results</span>
<span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">positions</span><span class="p">)</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span> <span class="c1"># convert to a np array</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">figaspect</span><span class="p">(</span><span class="mf">0.25</span><span class="p">))</span>

<span class="c1"># Energy as a function of position and particle trajectory</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">&#39;3d&#39;</span><span class="p">)</span>
<span class="c1"># Plot the Energy surface</span>
<span class="n">Xmesh</span><span class="p">,</span><span class="n">Ymesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">.</span><span class="mi">25</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="o">.</span><span class="mi">25</span><span class="p">))</span>
<span class="n">Zmesh</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="p">((</span><span class="n">Xmesh</span><span class="o">-</span><span class="n">o</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">Ymesh</span><span class="o">-</span><span class="n">o</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">())</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># potential energy surface</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">Xmesh</span><span class="p">,</span><span class="n">Ymesh</span><span class="p">,</span> <span class="n">Zmesh</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
<span class="c1"># Plot trajectory of the vertex E,x1,x2</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">positions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span><span class="n">Energies</span><span class="p">,</span><span class="s1">&#39;ro-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span><span class="n">positions</span><span class="p">[:</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span><span class="n">Energies</span><span class="p">[:</span><span class="mi">1</span><span class="p">],</span><span class="s1">&#39;mo&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span><span class="mi">0</span><span class="p">],</span><span class="n">positions</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:,</span><span class="mi">1</span><span class="p">],</span><span class="n">Energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:],</span><span class="s1">&#39;bo&#39;</span><span class="p">,</span><span class="n">ms</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;end&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;positions $x_1$&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;positions $x_2$&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">&#39;$Energy$&#39;</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>

<span class="c1"># Energy as function of time</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Energy&#39;</span><span class="p">)</span>

<span class="c1"># Vertex position (components) as a function of time</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">positions</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="s1">&#39;$x_1$&#39;</span><span class="p">,</span><span class="s1">&#39;$x_2$&#39;</span><span class="p">]);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Positions $x_i$&#39;</span><span class="p">);</span> <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Graph-usage-example"><a href="/vertex_simulation/primitives#Graph"><code>Graph</code></a> usage example<a class="anchor-link" href="#Graph-usage-example"> </a></h4><p><a name="ex2">Attracting particles in a 2D fluid</a></p>
<p>Now, let's evolve in time a system decribed by a potential
{% raw %}
$$U=k\sum_{\forall ij|j\neq i}|x_i-x_j|^2=k\sum_{\forall ij|j\neq i}l^2_{ij}$$
{% endraw %}
where every vertex $i$ is connected to all the other vertices $j$ with edges $ij$, and $x_i$ is the position of vertex $i$ on a 2D plane (vector). Force balance equation for this system, same as in <a href="#ex1">Example 1</a> is 
{% raw %}
$$b\frac{dx(t')}{dt'}=-\nabla U$$
{% endraw %}
$\nabla U$ is a function of distances between all possible pairs of vertices (edge lengths $l_{ij}$, scalars). The equation of motion for every vertex is (with $t=t'/b$)
{% raw %}
$$\frac{dx_i}{dt}=-k\sum_{\forall ij|j\neq i}2(x_i-x_j)= 2k\sum_{\forall ij|j\neq i}(x_j-x_i)$$
{% endraw %}
This system can be described by a complete graph, <code>G</code> in the code below. In order to demonstrate how to work with this type of systems, let's create a complete graph with $N_v$ vertices.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>
<span class="n">Nv</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># number of vertices</span>
<span class="n">Xv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,(</span><span class="n">Nv</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="c1"># initial vertex potions sampled from uniform distribution [0,1)</span>
<span class="n">edges</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nv</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">Nv</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span><span class="o">!=</span><span class="n">j</span><span class="p">]</span> <span class="c1"># list of edges for complete graph</span>
<span class="n">plot_graph</span><span class="p">(</span><span class="n">Xv</span><span class="p">,</span><span class="n">edges</span><span class="p">)</span> <span class="c1"># plot vertices and edges</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now, let's solve $x(t)$ with Euler's method. Note that in the code below, <code>Dt</code> must be smaller for large $N_v$ (e.g. about $0.01$ or less for $N_v=10$, and about $0.001$ for $N_v=100$). Try changing the parameters (one at a time) and observe what happens.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># initialize a graph</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">Graph</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">from_numpy</span><span class="p">(</span><span class="n">Xv</span><span class="p">)</span><span class="o">.</span><span class="n">clone</span><span class="p">(),</span><span class="n">requires_grad</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span> <span class="p">)</span>
<span class="n">G</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># turn on `Vertex` gradients; check its status with G.vertices.requires_grad()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of vertices:&#39;</span><span class="p">,</span><span class="n">G</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Number of edges:&#39;</span><span class="p">,</span> <span class="n">G</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
      <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Requires grad?:&#39;</span><span class="p">,</span><span class="n">G</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">())</span>

<span class="c1"># Define energy function</span>
<span class="n">k</span><span class="o">=</span><span class="mf">1.0</span>
<span class="n">energy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">l</span><span class="p">:</span> <span class="n">k</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">l</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># E = k sum(l_ij ^2)</span>
<span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">10</span> <span class="c1"># time step size</span>
<span class="n">positions</span> <span class="o">=</span> <span class="p">[</span><span class="n">G</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">()]</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">256</span><span class="p">):</span>
    <span class="n">G</span><span class="o">.</span><span class="n">set_zero_grad_</span><span class="p">()</span> <span class="c1"># reset grad accumulator</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">length</span><span class="p">())</span>  <span class="c1"># total potential energy of the system</span>
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="c1"># E(t-1)</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">G</span><span class="o">.</span><span class="n">get_vertex_grad</span><span class="p">()</span> <span class="c1"># dx/dt=-dE/dx</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">G</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
    <span class="n">positions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">%</span><span class="k">32</span>==0:
        <span class="n">mean_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=</span><span class="si">{t[-1]:2.3f}</span><span class="s1">: E={E.item():1.1g}; aver |dx/dt|= </span><span class="si">{mean_grad:1.1g}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energy</span><span class="p">(</span><span class="n">G</span><span class="o">.</span><span class="n">length</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">);</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Results for numerical integration above as a movie of the graph $G$:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">HTML</span><span class="p">(</span><span class="n">f_anim</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span> <span class="c1"># using HTML from IPython.display and matplotlib&#39;s animation module</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Monolayer-objects"><a href="/vertex_simulation/primitives#Monolayer"><code>Monolayer</code></a> objects<a class="anchor-link" href="#Monolayer-objects"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><a href="/vertex_simulation/primitives#Monolayer"><code>Monolayer</code></a> object stores vertices, edges, and cells and implements methods for working wiht torch's autograd. In order to demonstrate how to use <a href="/vertex_simulation/primitives#Monolayer"><code>Monolayer</code></a> objects, we start with generating cells. Here we will use Voronoi tessellation.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="k">import</span> <span class="n">Voronoi</span><span class="p">,</span><span class="n">voronoi_plot_2d</span>

<span class="n">v_seeds</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">5.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">5.5</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">4.</span><span class="p">],</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">4.</span><span class="p">],[</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">4.</span><span class="p">],[</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">],</span>
                  <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span><span class="mf">2.5</span><span class="p">],[</span><span class="mf">1.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">2.5</span><span class="p">],[</span><span class="mf">2.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">2.5</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">1.</span><span class="p">],[</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.</span><span class="p">]])</span>

<span class="n">vrn</span> <span class="o">=</span> <span class="n">Voronoi</span><span class="p">(</span><span class="n">v_seeds</span><span class="p">)</span>
<span class="n">voronoi_plot_2d</span><span class="p">(</span><span class="n">vrn</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>After obtaining the Voronoi tesselation, use <a href="/vertex_simulation/primitives#VoronoiRegions2Edges"><code>VoronoiRegions2Edges</code></a> to convert regions into a <a href="/vertex_simulation/primitives#Monolayer"><code>Monolayer</code></a> (and <a href="/vertex_simulation/primitives#Graph"><code>Graph</code></a>) compatible edges and cells representations:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">vrn</span><span class="o">.</span><span class="n">regions</span><span class="p">)</span> <span class="c1"># convert regions to edges and cells</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>cells</code> is the <code>dict</code> of edge indices. Negative edge indices indicate reversed vertex order:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">verts</span> <span class="o">=</span> <span class="n">Vertex</span><span class="p">(</span><span class="n">vrn</span><span class="o">.</span><span class="n">vertices</span><span class="p">)</span>
<span class="n">edges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">plot_graph</span><span class="p">(</span><span class="n">verts</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">edges</span><span class="p">)</span>

<span class="c1"># vertex indices</span>
<span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vrn</span><span class="o">.</span><span class="n">vertices</span><span class="p">):</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="p">,</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+.</span><span class="mi">1</span><span class="p">,</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{k}</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">c</span><span class="o">=</span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">5</span><span class="p">)</span>

<span class="c1"># cell edges</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">:</span>
    <span class="n">cell_edges</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span> <span class="c1"># edge indices (without direction)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
        <span class="c1"># reverse vertex order for negative edges</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">cell_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,:]</span><span class="o">.</span><span class="n">clone</span><span class="p">()</span>
        <span class="n">cell_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">cell_edges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">cells</span><span class="p">[</span><span class="n">c</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">tmp</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cell_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">verts</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">cell_edges</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],:],</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cell_edges</span><span class="p">:</span>
        <span class="n">e_xy</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">verts</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">e</span><span class="p">,:],</span><span class="mi">0</span><span class="p">)</span><span class="o">*.</span><span class="mi">65</span><span class="o">+</span><span class="n">cell_xy</span><span class="o">*.</span><span class="mi">35</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">e_xy</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">e_xy</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">f</span><span class="s2">&quot;{e.numpy()}&quot;</span><span class="p">,</span><span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Monolayer-dynamics-example"><a href="/vertex_simulation/primitives#Monolayer"><code>Monolayer</code></a> dynamics example<a class="anchor-link" href="#Monolayer-dynamics-example"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">import</span> <span class="nn">matplotlib.animation</span> <span class="k">as</span> <span class="nn">animation</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span><span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>

<span class="n">v_x</span><span class="p">,</span><span class="n">regions</span> <span class="o">=</span><span class="n">unit_hexagons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 4x4 hexagons</span>
<span class="c1"># convert Voronoi regions to cells and edges</span>
<span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
<span class="c1"># perturb vertices</span>
<span class="n">v_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*.</span><span class="mi">2</span>
<span class="c1"># define cell monolayer</span>
<span class="n">cell_graph</span> <span class="o">=</span> <span class="n">Monolayer</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span> <span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

<span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">graph2networkx_with_pos</span><span class="p">(</span><span class="n">cell_graph</span><span class="p">)</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Passive-forces-case">Passive forces case<a class="anchor-link" href="#Passive-forces-case"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># define cell monolayer</span>
<span class="n">v_x</span><span class="p">,</span><span class="n">regions</span> <span class="o">=</span><span class="n">unit_hexagons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 4x4 hexagons</span>
<span class="c1"># convert Voronoi regions to cells and edges</span>
<span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
<span class="c1"># perturb vertices</span>
<span class="n">v_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*.</span><span class="mi">2</span>

<span class="n">cell_graph</span> <span class="o">=</span> <span class="n">Monolayer</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span> <span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

<span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">graph2networkx_with_pos</span><span class="p">(</span><span class="n">cell_graph</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Define energy function</span>
<span class="n">energy</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">,</span><span class="n">a</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">a</span><span class="o">-</span><span class="mf">2.3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#</span>
<span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">3</span> <span class="c1"># time step size</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Forces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">verts_t</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">verts_frames</span><span class="o">=</span><span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="n">t_total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span>
<span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_total</span><span class="p">):</span>
    <span class="n">cell_graph</span><span class="o">.</span><span class="n">set_zero_grad_</span><span class="p">()</span> <span class="c1"># reset grad accumulator</span>
    <span class="n">E</span> <span class="o">=</span> <span class="n">energy</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">())</span>  <span class="c1"># total potential energy of the system</span>
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="c1"># E(t-1)</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">get_vertex_grad</span><span class="p">()</span> <span class="c1"># dx/dt=-dE/dx</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
        <span class="n">Forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="k">32</span>==0 or n==0:
        <span class="n">verts_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="n">verts_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">round</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">t_total</span><span class="o">/</span><span class="mi">12</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="c1">#plt.figure(figsize=figsize)</span>
        <span class="c1">#plot_graph_as_quiver(init_state,quiver_kwargs=quiver_kwargs)</span>
        <span class="c1">#plot_graph_as_quiver(cell_graph)</span>
        <span class="c1">#plt.axis(axs_lims)</span>
        <span class="c1">#plt.show()</span>
        <span class="n">mean_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=</span><span class="si">{t[-1]:2.3f}</span><span class="s1">: E={E.item():5.4g}; aver |dx/dt|= </span><span class="si">{mean_grad:3.2g}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span>

<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">energy</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">())</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">);</span>
<span class="c1"># add forces (except last frame)</span>
<span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average $|F|$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Forces</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Print final Perimeters and Areas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Perimeters:{cell_graph.perimeter().detach().squeeze()}</span><span class="se">\n</span><span class="s2">Areas:{cell_graph.area().detach()}&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">verts_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">verts_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Epoch:</span><span class="si">{verts_frames[i]:2.3f}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>

<span class="c1"># Networkx&#39;s edge ordering is different</span>
<span class="n">edge_idx</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="nb">tuple</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">tolist</span><span class="p">()],</span><span class="nb">range</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
<span class="n">edge_idx_order</span> <span class="o">=</span> <span class="p">[</span><span class="n">edge_idx</span><span class="p">[</span><span class="n">e</span> <span class="k">if</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edge_idx</span> <span class="k">else</span> <span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">Gnx</span><span class="o">.</span><span class="n">edges</span> <span class="p">]</span>
<span class="k">def</span> <span class="nf">draw_w_tension</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">verts_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span><span class="n">verts_t</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Epoch:</span><span class="si">{verts_frames[i]:2.3f}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1">#node_color=range(24), node_size=800, cmap=plt.cm.Blues</span>
    <span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span>
            <span class="n">edge_color</span><span class="o">=</span><span class="n">line_tensions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()[</span><span class="n">edge_idx_order</span><span class="p">],</span><span class="n">edge_cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">bwr</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
<span class="n">draw</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># draw the prediction of the first epoch</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">ani_passive</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">draw</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                              <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">)</span><span class="o">/</span><span class="mi">64</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Passive system (foam)&#39;</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani_passive</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span> <span class="c1"># using HTML from IPython.display and matplotlib&#39;s animation module</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Active-anisotropic-forces">Active anisotropic forces<a class="anchor-link" href="#Active-anisotropic-forces"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Edge-direction-is-independent">Edge direction is independent<a class="anchor-link" href="#Edge-direction-is-independent"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># define cell monolayer</span>
<span class="n">v_x</span><span class="p">,</span><span class="n">regions</span> <span class="o">=</span><span class="n">unit_hexagons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 4x4 hexagons</span>
<span class="c1"># convert Voronoi regions to cells and edges</span>
<span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
<span class="c1"># perturb vertices</span>
<span class="n">v_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*.</span><span class="mi">2</span>

<span class="n">cell_graph</span> <span class="o">=</span> <span class="n">Monolayer</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span> <span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

<span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">graph2networkx_with_pos</span><span class="p">(</span><span class="n">cell_graph</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Define energy function</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">monolayer_energy</span><span class="p">(</span><span class="n">Perm</span><span class="p">,</span><span class="n">Area</span><span class="p">,</span><span class="n">Leng</span><span class="p">,</span><span class="n">Tau</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
    <span class="n">dir_coeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">direction</span><span class="o">.</span><span class="n">detach</span><span class="p">()[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="o">.</span><span class="n">detach</span><span class="p">(),</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gamma_ij_by_lij</span> <span class="o">=</span> <span class="p">(</span><span class="n">Leng</span><span class="o">*</span><span class="n">dir_coeff</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">Tau</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="p">(</span><span class="n">Perm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Area</span><span class="o">-</span><span class="mf">2.3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma_ij_by_lij</span><span class="p">)),</span> <span class="n">dir_coeff</span>

<span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">3</span> <span class="c1"># time step size</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Forces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">verts_t</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">verts_frames</span><span class="o">=</span><span class="p">[]</span>
<span class="n">line_tensions</span><span class="o">=</span><span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="n">t_total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span>
<span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_total</span><span class="p">):</span>
    <span class="n">cell_graph</span><span class="o">.</span><span class="n">set_zero_grad_</span><span class="p">()</span> <span class="c1"># reset grad accumulator</span>
    <span class="c1"># total potential energy of the system:</span>
    <span class="n">E</span><span class="p">,</span><span class="n">edge_tensions</span> <span class="o">=</span> <span class="n">monolayer_energy</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                         <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())</span> 
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="c1"># E(t-1)</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">get_vertex_grad</span><span class="p">()</span> <span class="c1"># dx/dt=-dE/dx</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
        <span class="n">Forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="k">32</span>==0:
        <span class="n">verts_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="n">verts_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line_tensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">edge_tensions</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">round</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">t_total</span><span class="o">/</span><span class="mi">10</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">mean_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=</span><span class="si">{t[-1]:2.3f}</span><span class="s1">: E={E.item():5.4g}; aver |dx/dt|= </span><span class="si">{mean_grad:3.2g}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span> <span class="c1"># update last frame time</span>

<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">monolayer_energy</span><span class="p">(</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                                  <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">);</span>
<span class="c1"># add forces (except last frame)</span>
<span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average $|F|$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Forces</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Print final Perimeters and Areas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Perimeters:{cell_graph.perimeter().detach().squeeze()}</span><span class="se">\n</span><span class="s2">Areas:{cell_graph.area().detach()}&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ani_dir_no_grad</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">draw_w_tension</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                              <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">)</span><span class="o">/</span><span class="mi">64</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Direction is independent of positions (gradient==0)&#39;</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani_dir_no_grad</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span> <span class="c1"># using HTML from IPython.display and matplotlib&#39;s animation module</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="with-anisotropy-and-differentiable-edge-direction">with anisotropy and differentiable edge direction<a class="anchor-link" href="#with-anisotropy-and-differentiable-edge-direction"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># define cell monolayer</span>
<span class="n">v_x</span><span class="p">,</span><span class="n">regions</span> <span class="o">=</span><span class="n">unit_hexagons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 4x4 hexagons</span>
<span class="c1"># convert Voronoi regions to cells and edges</span>
<span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
<span class="c1"># perturb vertices</span>
<span class="n">v_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*.</span><span class="mi">2</span>

<span class="n">cell_graph</span> <span class="o">=</span> <span class="n">Monolayer</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span> <span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

<span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">graph2networkx_with_pos</span><span class="p">(</span><span class="n">cell_graph</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Define energy function</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">monolayer_energy</span><span class="p">(</span><span class="n">Perm</span><span class="p">,</span><span class="n">Area</span><span class="p">,</span><span class="n">Leng</span><span class="p">,</span><span class="n">Tau</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
    <span class="n">dir_coeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">direction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">gamma_ij_by_lij</span> <span class="o">=</span> <span class="p">(</span><span class="n">Leng</span><span class="o">*</span><span class="n">dir_coeff</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">Tau</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="p">(</span><span class="n">Perm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Area</span><span class="o">-</span><span class="mf">2.3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma_ij_by_lij</span><span class="p">)),</span> <span class="n">dir_coeff</span>

<span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">3</span> <span class="c1"># time step size</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Forces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">verts_t</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">verts_frames</span><span class="o">=</span><span class="p">[]</span>
<span class="n">line_tensions</span><span class="o">=</span><span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="n">t_total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span>

<span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_total</span><span class="p">):</span>
    <span class="n">cell_graph</span><span class="o">.</span><span class="n">set_zero_grad_</span><span class="p">()</span> <span class="c1"># reset grad accumulator</span>
    <span class="c1"># total potential energy of the system:</span>
    <span class="n">E</span><span class="p">,</span><span class="n">dir_coeff</span> <span class="o">=</span> <span class="n">monolayer_energy</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                         <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())</span> 
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="c1"># E(t-1)</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">get_vertex_grad</span><span class="p">()</span> <span class="c1"># dx/dt=-dE/dx</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
        <span class="n">Forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="k">32</span>==0:
        <span class="n">verts_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="n">verts_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line_tensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_coeff</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">round</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">t_total</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">mean_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=</span><span class="si">{t[-1]:2.3f}</span><span class="s1">: E={E.item():5.4g}; aver |dx/dt|= </span><span class="si">{mean_grad:3.2g}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span> <span class="c1"># update last frame time</span>

<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">monolayer_energy</span><span class="p">(</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                                  <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">);</span>
<span class="c1"># add forces (except last frame)</span>
<span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average $|F|$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Forces</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Print final Perimeters and Areas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Perimeters:{cell_graph.perimeter().detach().squeeze()}</span><span class="se">\n</span><span class="s2">Areas:{cell_graph.area().detach()}&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ani_dir_grad</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">draw_w_tension</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                              <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">)</span><span class="o">/</span><span class="mi">64</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Direction has gradient w.r.t. positions&#39;</span><span class="p">)</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani_dir_grad</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span> <span class="c1"># using HTML from IPython.display and matplotlib&#39;s animation module</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Anisotropic-active-forces-with-lower-amplitude">Anisotropic active forces with lower amplitude<a class="anchor-link" href="#Anisotropic-active-forces-with-lower-amplitude"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># define cell monolayer</span>
<span class="n">v_x</span><span class="p">,</span><span class="n">regions</span> <span class="o">=</span><span class="n">unit_hexagons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 4x4 hexagons</span>
<span class="c1"># convert Voronoi regions to cells and edges</span>
<span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
<span class="c1"># perturb vertices</span>
<span class="n">v_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*.</span><span class="mi">2</span>

<span class="n">cell_graph</span> <span class="o">=</span> <span class="n">Monolayer</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span> <span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

<span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">graph2networkx_with_pos</span><span class="p">(</span><span class="n">cell_graph</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Define energy function</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">monolayer_energy</span><span class="p">(</span><span class="n">Perm</span><span class="p">,</span><span class="n">Area</span><span class="p">,</span><span class="n">Leng</span><span class="p">,</span><span class="n">Tau</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
    <span class="n">dir_coeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">direction</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span><span class="o">/</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">5</span>
    <span class="n">gamma_ij_by_lij</span> <span class="o">=</span> <span class="p">(</span><span class="n">Leng</span><span class="o">*</span><span class="n">dir_coeff</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">Tau</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">.</span><span class="mi">01</span><span class="o">*</span><span class="p">(</span><span class="n">Perm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Area</span><span class="o">-</span><span class="mf">2.3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma_ij_by_lij</span><span class="p">)),</span> <span class="n">dir_coeff</span>

<span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">3</span> <span class="c1"># time step size</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Forces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">verts_t</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">verts_frames</span><span class="o">=</span><span class="p">[]</span>
<span class="n">line_tensions</span><span class="o">=</span><span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="n">t_total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">8</span>

<span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_total</span><span class="p">):</span>
    <span class="n">cell_graph</span><span class="o">.</span><span class="n">set_zero_grad_</span><span class="p">()</span> <span class="c1"># reset grad accumulator</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span> <span class="c1"># update last frame time</span>
    <span class="c1"># total potential energy of the system:</span>
    <span class="n">E</span><span class="p">,</span><span class="n">dir_coeffs</span> <span class="o">=</span> <span class="n">monolayer_energy</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                         <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())</span> 
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="c1"># E(t-1)</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">get_vertex_grad</span><span class="p">()</span> <span class="c1"># dx/dt=-dE/dx</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
        <span class="n">Forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="k">32</span>==0:
        <span class="n">verts_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="n">verts_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line_tensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_coeffs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">round</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">t_total</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">mean_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=</span><span class="si">{t[-1]:2.3f}</span><span class="s1">: E={E.item():5.4g}; aver |dx/dt|= </span><span class="si">{mean_grad:3.2g}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">monolayer_energy</span><span class="p">(</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                                  <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">);</span>
<span class="c1"># add forces (except last frame)</span>
<span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average $|F|$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Forces</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Print final Perimeters and Areas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Perimeters:{cell_graph.perimeter().detach().squeeze()}</span><span class="se">\n</span><span class="s2">Areas:{cell_graph.area().detach()}&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ani_dir_grad_low_amplitude</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">draw_w_tension</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                              <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">)</span><span class="o">/</span><span class="mi">64</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Direction has gradient w.r.t. positions (low line tension: 1/5)&#39;</span><span class="p">)</span>
<span class="c1"># using HTML from IPython.display and matplotlib&#39;s animation module</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani_dir_grad_low_amplitude</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h4 id="Random-edges-with-active-tension">Random edges with active tension<a class="anchor-link" href="#Random-edges-with-active-tension"> </a></h4>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">e_ij_coeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">e_ij_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;.</span><span class="mi">2</span>
<span class="n">e_ij_coeff</span><span class="p">[</span><span class="n">e_ij_on</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1"># define cell monolayer</span>
<span class="n">v_x</span><span class="p">,</span><span class="n">regions</span> <span class="o">=</span><span class="n">unit_hexagons</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 4x4 hexagons</span>
<span class="c1"># convert Voronoi regions to cells and edges</span>
<span class="n">edge_list</span><span class="p">,</span><span class="n">cells</span> <span class="o">=</span> <span class="n">VoronoiRegions2Edges</span><span class="p">(</span><span class="n">regions</span><span class="p">)</span>
<span class="c1"># perturb vertices</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span> <span class="c1"># let&#39;s seed RNG for sanity and reproducibility</span>
<span class="n">v_x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v_x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">*.</span><span class="mi">2</span>

<span class="n">cell_graph</span> <span class="o">=</span> <span class="n">Monolayer</span><span class="p">(</span><span class="n">vertices</span><span class="o">=</span><span class="n">Vertex</span><span class="p">(</span><span class="n">v_x</span><span class="o">.</span><span class="n">copy</span><span class="p">()),</span> <span class="n">edges</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span> <span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">)</span>

<span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="o">=</span><span class="n">graph2networkx_with_pos</span><span class="p">(</span><span class="n">cell_graph</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">])</span>
<span class="n">fig</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="kc">False</span><span class="p">);</span>
<span class="n">nx</span><span class="o">.</span><span class="n">draw</span><span class="p">(</span><span class="n">Gnx</span><span class="p">,</span><span class="n">pos</span><span class="p">,</span><span class="n">node_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span><span class="n">node_color</span><span class="o">=</span><span class="s1">&#39;#FF00FF&#39;</span><span class="p">,</span><span class="n">edge_color</span><span class="o">=</span><span class="s1">&#39;#51C5FF&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># Define energy function</span>
<span class="n">omega</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">],</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">e_ij_coeff</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span><span class="mi">1</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="n">e_ij_on</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_list</span><span class="p">),</span><span class="mi">1</span><span class="p">)</span><span class="o">&lt;.</span><span class="mi">2</span>
<span class="n">e_ij_coeff</span><span class="p">[</span><span class="n">e_ij_on</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">e_ij_phase</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">e_ij_coeff</span><span class="p">)</span>
<span class="n">e_ij_phase</span><span class="p">[</span><span class="n">e_ij_on</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">((</span><span class="n">e_ij_on</span><span class="o">.</span><span class="n">sum</span><span class="p">(),),</span><span class="n">dtype</span><span class="o">=</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">monolayer_energy</span><span class="p">(</span><span class="n">Perm</span><span class="p">,</span><span class="n">Area</span><span class="p">,</span><span class="n">Leng</span><span class="p">,</span><span class="n">Tau</span><span class="p">,</span><span class="n">direction</span><span class="p">):</span>
    <span class="n">gamma_ij_by_lij</span> <span class="o">=</span> <span class="p">(</span><span class="n">Leng</span><span class="o">*</span><span class="n">e_ij_coeff</span><span class="o">/</span><span class="mi">5</span><span class="p">)</span><span class="o">*</span><span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="n">Tau</span><span class="o">+</span><span class="n">e_ij_phase</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="o">*</span><span class="p">(</span><span class="n">Perm</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Area</span><span class="o">-</span><span class="mf">2.3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gamma_ij_by_lij</span><span class="p">)),</span><span class="n">gamma_ij_by_lij</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

<span class="c1"># Numerical integration</span>
<span class="n">Dt</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**-</span><span class="mi">5</span> <span class="c1"># time step size</span>
<span class="n">t</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">Energies</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">Forces</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">verts_t</span> <span class="o">=</span><span class="p">[]</span>
<span class="n">verts_frames</span><span class="o">=</span><span class="p">[]</span>
<span class="n">line_tensions</span><span class="o">=</span><span class="p">[]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Integration (Euler</span><span class="se">\&#39;</span><span class="s1">s method):&#39;</span><span class="p">)</span>
<span class="n">t_total</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span>

<span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">t_total</span><span class="p">):</span>
    <span class="n">cell_graph</span><span class="o">.</span><span class="n">set_zero_grad_</span><span class="p">()</span> <span class="c1"># reset grad accumulator</span>
    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">Dt</span><span class="p">)</span> <span class="c1"># update last frame time</span>
    <span class="c1"># total potential energy of the system:</span>
    <span class="n">E</span><span class="p">,</span><span class="n">dir_coeffs</span> <span class="o">=</span> <span class="n">monolayer_energy</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                         <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                        <span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())</span> 
    <span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">E</span><span class="o">.</span><span class="n">item</span><span class="p">())</span> <span class="c1"># E(t-1)</span>
    <span class="n">E</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span> <span class="c1"># compute gradients</span>
    <span class="n">dxdt</span> <span class="o">=</span> <span class="o">-</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">get_vertex_grad</span><span class="p">()</span> <span class="c1"># dx/dt=-dE/dx</span>
    <span class="c1"># Update vertex position</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">dxdt</span><span class="o">*</span><span class="n">Dt</span>
        <span class="n">Forces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">())</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="k">32</span>==0:
        <span class="n">verts_t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
        <span class="n">verts_frames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">line_tensions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dir_coeffs</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">clone</span><span class="p">())</span>
    <span class="k">if</span> <span class="nb">round</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="p">(</span><span class="n">t_total</span><span class="o">/</span><span class="mi">8</span><span class="p">))</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">mean_grad</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">dxdt</span><span class="p">,</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;t=</span><span class="si">{t[-1]:2.3f}</span><span class="s1">: E={E.item():5.4g}; aver |dx/dt|= </span><span class="si">{mean_grad:3.2g}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">Energies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">monolayer_energy</span><span class="p">(</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">perimeter</span><span class="p">(),</span> <span class="n">cell_graph</span><span class="o">.</span><span class="n">area</span><span class="p">(),</span>
                                  <span class="n">cell_graph</span><span class="o">.</span><span class="n">length</span><span class="p">(),</span><span class="n">t</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">cell_graph</span><span class="o">.</span><span class="n">direction</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span><span class="n">Energies</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">);</span><span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">);</span>
<span class="c1"># add forces (except last frame)</span>
<span class="n">ax2</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Average $|F|$&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">Forces</span><span class="p">,</span><span class="s1">&#39;r-&#39;</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">4</span><span class="p">,</span><span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
<span class="c1"># Print final Perimeters and Areas</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Perimeters:{cell_graph.perimeter().detach().squeeze()}</span><span class="se">\n</span><span class="s2">Areas:{cell_graph.area().detach()}&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ani_dir_grad_low_mem_low</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">draw_w_tension</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                              <span class="n">frames</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">),</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">verts_t</span><span class="p">)</span><span class="o">/</span><span class="mi">128</span><span class="p">))))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Random edges with active tension&#39;</span><span class="p">)</span>
<span class="c1"># using HTML from IPython.display and matplotlib&#39;s animation module</span>
<span class="n">HTML</span><span class="p">(</span><span class="n">ani_dir_grad_low_mem_low</span><span class="o">.</span><span class="n">to_jshtml</span><span class="p">())</span> 
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

</div>
 

